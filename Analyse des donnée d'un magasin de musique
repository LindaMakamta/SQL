SELECT BILLINGCITY  ,COUNT(BILLINGCITY  ) AS Invoice_Number
FROM INVOICES I 
GROUP BY BILLINGCITY  
ORDER BY Invoice_Number DESC;

SELECT  BILLINGCITY , COUNT(BILLINGCITY) AS NumberCity 
from INVOICES I  
GROUP BY BILLINGCITY  
ORDER BY NumberCity DESC;

SELECT  BILLINGCITY , SUM(TOTAL) AS TotalinvC 
from INVOICES I  
GROUP BY BILLINGCITY  
ORDER BY TotalinvC DESC
LIMIT 1;


SELECT C.CUSTOMERID, FIRSTNAME, LASTNAME, SUM(total) AS sumdepense
from CUSTOMERS C 
JOIN INVOICES I ON C.CUSTOMERID =I.CUSTOMERID 
GROUP BY C.CUSTOMERID  
ORDER BY sumdepense DESC
LIMIT 1;


SELECT  email, FIRSTNAME ,lastName   
from  CUSTOMERS C 
JOIN INVOICES I ON C.CUSTOMERID =I.CUSTOMERID 
JOIN INVOICE_ITEMS II ON I.INVOICEID =II.INVOICEID 
WHERE TRACKID  IN (SELECT TRACKID  FROM TRACKS T
                    JOIN GENRES G ON T.GENREID =G.GENREID
                    WHERE  G.NAME LIKE'Rock')
ORDER BY EMAIL ;

SELECT  C.EMAIL , C.FIRSTNAME ,C.LASTNAME ,G.NAME  
from  CUSTOMERS C 
JOIN  INVOICES I ON C.CUSTOMERID = I.CUSTOMERID 
JOIN  INVOICE_ITEMS II ON I.INVOICEID =II.INVOICEID 
JOIN TRACKS T  ON T.TRACKID  = II.TRACKID 
JOIN GENRES G  ON G.GENREID  = T.GENREID 
  WHERE  G.NAME LIKE  'Rock'

ORDER BY numberClt;

SELECT  G.NAME ,city 
from  GENRES G 
JOIN TRACKS T ON G.GENREID =T.GENREID 
JOIN INVOICE_ITEMS II ON T.TRACKID =II.TRACKID 
JOIN INVOICES I ON II.INVOICEID = I.INVOICEID 
JOIN  CUSTOMERS C ON I.CUSTOMERID =C.CUSTOMERID 
 
SELECT  A2.ARTISTID  , A2.NAME  , COUNT(A2.ARTISTID) AS numberSong
from TRACKS T 
INNER JOIN ALBUMS A ON T.ALBUMID = A.ALBUMID 
INNER  JOIN  ARTISTS A2 ON A.ARTISTID = A2.ARTISTID 
INNER JOIN  GENRES G ON T.GENREID = G.GENREID 
WHERE  G.NAME LIKE 'Rock'
GROUP BY A2.NAME 
ORDER BY  numberSong  DESC 

WITH TabBestArtist AS (
SELECT  AR.ARTISTID AS ARTISTID , AR.NAME AS NAME , SUM(II.UNITPRICE*II.QUANTITY) AS totalVente
FROM INVOICE_ITEMS II 
JOIN TRACKS T ON II.TRACKID  = T.TRACKID 
INNER JOIN  ALBUMS A ON T.ALBUMID =A.ALBUMID 
INNER JOIN  ARTISTS AR ON A.ARTISTID = AR.ARTISTID
GROUP BY 1
ORDER BY 3 DESC 
LIMIT 1
)
SELECT TB.NAME , SUM(II.UNITPRICE*II.QUANTITY) AS amountSpent ,C.CUSTOMERID ,C.FIRSTNAME  ,C.LASTNAME  
FROM  INVOICES I 
JOIN  INVOICE_ITEMS II ON I.INVOICEID =II.INVOICEID 
JOIN TRACKS T  ON T.TRACKID  = II.TRACKID 
JOIN ALBUMS A ON T.ALBUMID =A.ALBUMID 
JOIN  ARTISTS AR ON A.ARTISTID = AR.ARTISTID
INNER JOIN  CUSTOMERS C   ON I.CUSTOMERID = C.CUSTOMERID 
JOIN  TabBestArtist TB  ON A.ARTISTID = TB.ARTISTID
GROUP  BY 1
ORDER BY 2 DESC ;  

SELECT  COUNT(*)AS achactGenre, C.COUNTRY ,G.NAME ,G.GENREID 
FROM  INVOICE_ITEMS II 
JOIN  INVOICES I  ON I.INVOICEID =II.INVOICEID 
JOIN CUSTOMERS C   ON I.CUSTOMERID = C.CUSTOMERID
JOIN TRACKS T  ON T.TRACKID  = II.TRACKID 
 JOIN  GENRES G ON T.GENREID = G.GENREID 
 GROUP BY 2,4
ORDER BY 2;

WITH RECURSIVE
	tbl_sales_per_country AS(
		SELECT COUNT(*) AS purchases_per_genre, customers.country, genres.name, genres.genreid
		FROM INVOICE_ITEMS
		JOIN invoices ON invoices.invoiceid = INVOICE_ITEMS.invoiceid
		JOIN customers ON customers.customerid = invoices.customerid
		JOIN tracks ON tracks.trackid = INVOICE_ITEMS.trackid
		JOIN genres ON genres.genreid = tracks.genreid
		GROUP BY 2,3,4
		ORDER BY 2
	)
SELECT MAX(purchases_per_genre)AS MaxGenreNumber , country
from tbl_sales_per_country
GROUP BY 2
ORDER BY 2;


